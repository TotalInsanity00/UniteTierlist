<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="src/Icon.png">
  <title>Pokémon Unite Tier List</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      margin: 0;
      background-color: #111;
      font-family: 'Roboto', sans-serif;
      color: white;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow-x: hidden;
    }

    .tier-list {
      flex: 3;
      padding: 20px;
      overflow-y: auto;
    }

    .save-reset {
      position: sticky;
      top: 0;
      background-color: #111;
      z-index: 20;
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 2px solid #222;
    }

    .button-group,
    .tier-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      margin-top: 10px;
    }

    button {
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background-color: #444;
    }

    .tier {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
      background: #1c1c1c;
      border-radius: 10px;
      padding: 10px;
      transition: all 0.2s ease;
    }

    .tier-label {
      width: 100px;
      font-weight: bold;
      text-align: center;
      border-radius: 5px;
      padding: 5px;
      margin-right: 10px;
      cursor: pointer;
      user-select: none;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      word-break: break-word;
      position: relative;
    }

    .color-picker {
      margin-top: 5px;
      display: none;
      width: 80%;
      border: none;
      border-radius: 5px;
    }

    /* Pencil icon (base state hidden) */
    .edit-icon {
      display: none;
      position: absolute;
      left: -35px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 15px;
      cursor: pointer;
      background: #333;
      border-radius: 50%;
      padding: 6px;
      border: 1px solid #555;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .edit-icon:hover {
      background: #555;
    }

    .tier-content {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 5px;
      min-height: 60px;
      border: 2px dashed transparent;
      transition: all 0.2s ease;
    }

    .tier-content.dragover {
      border: 2px dashed #888;
    }

    .pokemon-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #222;
      overflow: hidden;
      cursor: grab;
      transition: transform 0.2s;
      flex: 0 0 auto;
      border: 3px solid transparent;
    }

    .pokemon-icon:hover {
      transform: scale(1.1);
    }

    .pokemon-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* not cover */
      object-position: center;
      pointer-events: none;
    }

    .attackers {
      border-color: #cc1d11;
    }

    .allrounders {
      border-color: #4e0d8a;
    }

    .defenders {
      border-color: #0a6831;
    }

    .supporters {
      border-color: #e2d627;
    }

    .speedsters {
      border-color: #2e52f3;
    }

    .side-panel {
      flex: 1;
      background-color: #1a1a1a;
      border-left: 3px solid #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 10px;
      overflow: hidden;
    }

    .character-preview {
      width: 100%;
      height: 100%;
      border-radius: 2px;
      overflow: hidden;
      cursor: pointer;
      margin: 0 0 -250px 0;
      background: url('./preview/preview_blaziken.png') no-repeat top center;
      background-size: contain;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .character-preview img {
      max-width: 60%;
      max-height: 60%;
      object-fit: contain;
      pointer-events: none;
      display: block;
      margin-left: auto;
      margin-right: 10px;
      margin-bottom: 275px;
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      justify-items: center;
      flex: 1 1 auto;
      overflow-y: auto;
      width: 100%;
    }

    /* --- MOBILE LAYOUT --- */
    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: auto;
      }

      .tier-list {
        flex: none;
        padding-bottom: 150px;
      }

      .side-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 140px;
        background-color: #1a1a1a;
        border-top: 3px solid #333;
        border-left: none;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        z-index: 50;
        padding: 5px;
      }

      .character-preview {
        display: none;
      }

      .character-grid {
        display: grid;
        grid-auto-flow: column;
        grid-template-columns: none;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        width: 100%;
        padding: 5px;
        gap: 8px;
        justify-items: start;
        scrollbar-width: none;
      }

      .character-grid::-webkit-scrollbar {
        display: none;
      }

      .pokemon-icon {
        flex: 0 0 auto;
        width: 55px;
        height: 55px;
      }

      /* Show pencil icon only on mobile */
      .edit-icon {
        display: flex;
      }
    }

    /* Mobile tap-to-swap highlight */
    .swap-selected {
      outline: 3px solid #ffd700;
      transform: scale(1.1);
    }
  </style>

</head>

<body>
  <div class="tier-list" id="tierList">
    <div class="save-reset">
      <button id="save">SAVE</button>
      <button id="reset">RESET</button>
    </div>

    <div class="tier-controls">
      <button id="addTier">+ ADD TIER</button>
      <button id="removeTier">- REMOVE TIER</button>
    </div>

    <div id="tiers-container">
      <div class="tier">
        <div class="tier-label" style="background-color: #ff5722;" contenteditable="true">
          S TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#ff5722">
        </div>
        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #ffca28;" contenteditable="true">
          A TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#ffca28">
        </div>
        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #8bc34a;" contenteditable="true">
          B TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#8bc34a">
        </div>
        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #132781;" contenteditable="true">
          C TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#132781">
        </div>
        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #610f75;" contenteditable="true">
          D TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#610f75">
        </div>
        <div class="tier-content"></div>
      </div>
    </div>
  </div>

  <div class="side-panel">
    <div class="character-preview" id="preview">
      <img src="" alt="">
    </div>
    <div class="character-grid" id="character-grid"></div>
  </div>

  <script>
    // existing code unchanged up to setupColorPickers()

    function setupColorPickers() {
      document.querySelectorAll('.tier-label').forEach(label => {
        const picker = label.querySelector('.color-picker');
        const pencil = label.querySelector('.edit-icon');

        label.addEventListener('dblclick', e => {
          e.stopPropagation();
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        });

        // mobile pencil tap
        if (pencil) {
          pencil.addEventListener('click', e => {
            e.stopPropagation();
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
          });
        }

        picker.addEventListener('input', e => {
          label.style.backgroundColor = e.target.value;
        });

        label.addEventListener('click', e => e.stopPropagation());
        document.addEventListener('click', e => {
          if (!label.contains(e.target)) picker.style.display = 'none';
        });
      });
    }

    setupColorPickers();

    // rest of JS unchanged
  </script>
</body>

</html>


<script>

  const imageSettings = {
    "venusaur": {
      "icon": {
        "scale": 1.8,
        "xOffset": -3,
        "yOffset": -3
      }
    },
    "delphox": {
      "icon": {
        "scale": 2.2,
        "xOffset": -1,
        "yOffset": 5
      }
    },
    "charizard": {
      "icon": {
        "scale": 1.8,
        "xOffset": 15,
        "yOffset": -2
      }
    }
  }
  const attackers = ['Latios', 'Alolan-Raichu', 'Armarouge', 'Miraidon', 'Mewtwoy', 'Inteleon', 'Chandelure',
    'Dragapult', 'Mew', 'Glaceon', 'Delphox', 'Espeon', 'Duraludon', 'Decidueye', 'Sylveon', 'Gardevoir', 'Pikachu', 'Greninja', 'Venusaur', 'Alolan-Ninetales', 'Cramorant', 'Cinderace'];
  const allrounders = ['Empoleon', 'Pawmot', 'Suicune', 'Tinkaton', 'Ceruledge', 'Falinks', 'Gyarados', 'Metagross', 'Mimikyu',
    'Blaziken', 'Zacian', 'Urshifuss', 'Urshifurs', 'Scizor', 'Tyranitar', 'Buzzwole', 'Azumarill', 'Aegislash', 'Dragonite',
    'Tsareena', 'Charizard', 'Lucario', 'Machamp', 'Garchomp', 'Mewtwox', 'Charizardx', 'mLucario'];
  const defenders = ['Ho-Oh', 'Umbreon', 'Lapras', 'Goodra', 'Trevenant', 'Greedent', 'Mamoswine', 'Blastoise', 'Snorlax', 'Crustle', 'Slowbro'];
  const supporters = ['Latias', 'Alcremie', 'Psyduck', 'Comfey', 'Sableye', 'Clefable', 'Hoopa', 'Blissey', 'Eldegoss', 'Mr-Mime', 'Wigglytuff'];
  const speedsters = ['Galarian-Rapidash', 'Scyther', 'Darkrai', 'Meowscarada', 'Leafeon', 'Zoroark', 'Dodrio', 'Zeraora', 'Talonflame', 'Absol', 'Gengar'];

  const categories = { attackers, allrounders, defenders, supporters, speedsters };
  const grid = document.getElementById('character-grid');
  const previewContainer = document.getElementById('preview');
  const previewImg = previewContainer.querySelector('img');
  let selectedPokemon = null;

  // --- Drag + Touch placement ---
  function setupDragAndDrop() {
    const tiers = document.querySelectorAll('.tier-content');

    tiers.forEach(tier => {
      tier.addEventListener('dragover', e => {
        e.preventDefault();
        tier.classList.add('dragover');

        const dragging = document.querySelector('.dragging, .dragging-icon');
        if (!dragging) return;

        const afterElement = getDragAfterElement(tier, e.clientX);
        if (afterElement == null) {
          tier.appendChild(dragging);
        } else {
          tier.insertBefore(dragging, afterElement);
        }
      });

      tier.addEventListener('dragleave', () => tier.classList.remove('dragover'));

      tier.addEventListener('drop', e => {
        e.preventDefault();
        tier.classList.remove('dragover');
        const dragging = document.querySelector('.dragging, .dragging-icon');
        if (dragging) {
          const afterElement = getDragAfterElement(tier, e.clientX);
          if (afterElement == null) {
            tier.appendChild(dragging);
          } else {
            tier.insertBefore(dragging, afterElement);
          }

          previewImg.src = `./pokemon/unite_${dragging.dataset.name.toLowerCase()}.png`;
          previewImg.alt = dragging.dataset.name;
        }
        setupIconReordering(); // keep reordering active
      });

      // --- Mobile tap-to-place support ---
      tier.addEventListener('click', e => {
        if (selectedPokemon) {
          tier.appendChild(selectedPokemon);
          previewImg.src = `./pokemon/unite_${selectedPokemon.dataset.name.toLowerCase()}.png`;
          previewImg.alt = selectedPokemon.dataset.name;
          selectedPokemon.classList.remove('selected-touch');
          selectedPokemon = null;
          setupIconReordering();
        }
      });
    });
  }


  // --- Generate Pokémon icons ---
  Object.entries(categories).forEach(([role, names]) => {
    names.forEach(name => {
      const div = document.createElement('div');
      div.className = `pokemon-icon ${role}`;
      div.draggable = true;
      div.dataset.name = name;
      const lower = name.toLowerCase();
      const settings = imageSettings[lower]?.icon || { scale: 1, xOffset: 0, yOffset: 0 };

      div.innerHTML = `
    <img 
      src="./pokemon/unite_${lower}.png" 
      alt="${name}" 
      style="transform: scale(${settings.scale}) translate(${settings.xOffset}px, ${settings.yOffset}px);"
    >
  `;


      div.addEventListener('dragstart', () => div.classList.add('dragging'));
      div.addEventListener('dragend', () => div.classList.remove('dragging'));

      div.addEventListener('click', e => {
        if (isTouchDevice()) {
          e.stopPropagation();
          if (selectedPokemon === div) {
            div.classList.remove('selected-touch'); selectedPokemon = null;
          } else {
            if (selectedPokemon) selectedPokemon.classList.remove('selected-touch');
            selectedPokemon = div;
            div.classList.add('selected-touch');
          }
        }
        const lower = name.toLowerCase();
        previewImg.src = `./pokemon/unite_${lower}.png`;
        const settings = imageSettings[lower]?.preview || imageSettings[lower]?.icon || { scale: 1, xOffset: 0, yOffset: 0 };
        previewImg.style.transform = `scale(${settings.scale}) translate(${settings.xOffset}px, ${settings.yOffset}px)`;

        previewImg.alt = name;
      });

      grid.appendChild(div);
    });
  });

  document.body.addEventListener('click', e => {
    if (selectedPokemon && !e.target.classList.contains('pokemon-icon')) {
      selectedPokemon.classList.remove('selected-touch');
      selectedPokemon = null;
    }
  });

  previewContainer.addEventListener('click', () => {
    if (previewImg.alt && previewImg.alt !== "Preview")
      window.open(`https://unite-db.com/pokemon/${previewImg.alt.toLowerCase()}`, '_blank');
  });

  setupDragAndDrop();

  // --- Reset ---
  document.getElementById('reset').addEventListener('click', () => {
    const allIcons = document.querySelectorAll('.pokemon-icon');
    const grid = document.getElementById('character-grid');
    allIcons.forEach(icon => grid.appendChild(icon));
    previewImg.src = "https://via.placeholder.com/300x150?text=Click+Pokemon";
    previewImg.alt = "Preview";
    selectedPokemon = null;
  });

  document.getElementById("save").addEventListener("click", () => {
    const tierList = document.querySelector(".tier-list");
    const images = tierList.querySelectorAll(".pokemon-icon img");

    // Apply the pixelated rendering hint directly without storing/restoring transform
    images.forEach((img) => {
      img.style.imageRendering = "pixelated"; // Keeps them crisp
    });

    // Wait for images to load completely
    const loadPromises = Array.from(images).map(img => {
      if (img.complete) return Promise.resolve();
      return new Promise(resolve => {
        img.onload = resolve;
        img.onerror = resolve;
      });
    });

    Promise.all(loadPromises).then(() => {
      html2canvas(tierList, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#111", // solid background looks cleaner than transparent
      }).then(canvas => {
        // Restore image rendering after capture
        images.forEach((img) => {
          img.style.imageRendering = "auto";
        });

        // Save PNG
        const link = document.createElement("a");
        link.download = "unite-tier-list.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(err => {
        console.error("Error saving tier list:", err);
        alert("Something went wrong while saving.");
      });
    });
  });

  document.getElementById('addTier').addEventListener('click', () => {
    const container = document.getElementById('tiers-container');
    const currentTierCount = container.querySelectorAll('.tier').length;

    // ✅ Limit to 10 tiers max
    if (currentTierCount >= 16) {
      alert('You can only have up to 16 tiers!');
      return;
    }

    // --- create new tier normally ---
    const tier = document.createElement('div');
    tier.className = 'tier';
    const color = '#' + Math.floor(Math.random() * 16777215).toString(16);
    tier.innerHTML = `
      <div class="tier-label" style="background-color:${color};" contenteditable="true">
        NEW TIER
        <span class="edit-icon">✏️</span>
        <input type="color" class="color-picker" value="${color}">
      </div>
      <div class="tier-content"></div>`;

    container.appendChild(tier);

    // --- reapply scripts to new tier ---
    setupDragAndDrop();
    setupColorPickers();
    setupMobilePencils();
    setupTierReordering();
    setupIconReordering();
  });

  // --- Remove Tier (fixed so characters return to grid) ---
  document.getElementById('removeTier').addEventListener('click', () => {
    const container = document.getElementById('tiers-container');
    const last = container.lastElementChild;
    const grid = document.getElementById('character-grid');

    if (last) {
      // Move all Pokémon back to the grid before removing the tier
      const icons = last.querySelectorAll('.pokemon-icon');
      icons.forEach(icon => grid.appendChild(icon));

      // Now remove the tier
      container.removeChild(last);
    }
  });


  // --- Color picker + pencil toggle ---
  function setupColorPickers() {
    document.querySelectorAll('.tier-label').forEach(label => {
      const picker = label.querySelector('.color-picker');
      const pencil = label.querySelector('.edit-icon');

      // remove old listeners to avoid duplicates
      label.replaceWith(label.cloneNode(true));
    });

    document.querySelectorAll('.tier-label').forEach(label => {
      const picker = label.querySelector('.color-picker');
      const pencil = label.querySelector('.edit-icon');

      // --- double-click color picker toggle (desktop) ---
      label.addEventListener('dblclick', e => {
        e.stopPropagation();
        picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
      });

      // --- pencil toggle (mobile & desktop) ---
      if (pencil) {
        pencil.onclick = e => {
          e.stopPropagation();
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        };
      }

      // --- color live update ---
      picker.addEventListener('input', e => {
        label.style.backgroundColor = e.target.value;
      });

      // --- hide picker when clicking outside ---
      label.addEventListener('click', e => e.stopPropagation());
      document.addEventListener('click', e => {
        if (!label.contains(e.target)) picker.style.display = 'none';
      });
    });
  }


  // --- Mobile: fix pencil placement + behavior ---
  function setupMobilePencils() {
    if (window.innerWidth <= 768) {
      document.querySelectorAll('.tier-label').forEach(label => {
        let pencil = label.querySelector('.edit-icon');
        const picker = label.querySelector('.color-picker');

        if (!pencil) {
          pencil = document.createElement('span');
          pencil.className = 'edit-icon';
          pencil.textContent = '✏️';
          label.insertAdjacentElement('afterbegin', pencil);
        }

        pencil.onclick = e => {
          e.stopPropagation();
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        };
      });
    }
  }

  setupColorPickers();
  setupMobilePencils();

  // --- Helper ---
  function isTouchDevice() {
    return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
  }

  // --- Enable tier reordering on desktop ---
  function setupTierReordering() {
    const tiersContainer = document.getElementById('tiers-container');
    const tiers = tiersContainer.querySelectorAll('.tier');

    tiers.forEach(tier => {
      tier.draggable = true;

      tier.addEventListener('dragstart', e => {
        if (window.innerWidth <= 768) return; // disable on mobile
        e.dataTransfer.effectAllowed = 'move';
        tier.classList.add('dragging-tier');
      });

      tier.addEventListener('dragend', () => {
        tier.classList.remove('dragging-tier');
      });

      tier.addEventListener('dragover', e => {
        if (window.innerWidth <= 768) return;
        e.preventDefault();
        const dragging = document.querySelector('.dragging-tier');
        if (!dragging || dragging === tier) return;

        const rect = tier.getBoundingClientRect();
        const offset = e.clientY - rect.top;
        const halfway = rect.height / 2;

        // Move dragging tier before or after hovered tier depending on mouse position
        if (offset < halfway) {
          tiersContainer.insertBefore(dragging, tier);
        } else {
          tiersContainer.insertBefore(dragging, tier.nextSibling);
        }
      });
    });
  }

  // run once now and again after adding new tiers
  setupTierReordering();

  // also run again when a new tier is added
  const originalAddTier = document.getElementById('addTier').onclick;
  document.getElementById('addTier').onclick = () => {
    originalAddTier?.();
    setupTierReordering();
  };

  // --- Enable Pokémon reordering within tiers ---
  function setupIconReordering() {
    const tiers = document.querySelectorAll('.tier-content');

    tiers.forEach(tier => {
      tier.querySelectorAll('.pokemon-icon').forEach(icon => {
        icon.draggable = true;

        icon.addEventListener('dragstart', e => {
          e.dataTransfer.effectAllowed = 'move';
          icon.classList.add('dragging-icon');
        });

        icon.addEventListener('dragend', () => {
          icon.classList.remove('dragging-icon');
        });
      });

      tier.addEventListener('dragover', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging-icon');
        if (!dragging) return;

        const afterElement = getDragAfterElement(tier, e.clientX);
        if (afterElement == null) {
          tier.appendChild(dragging);
        } else {
          tier.insertBefore(dragging, afterElement);
        }
      });
    });
  }

  function getDragAfterElement(container, x) {
    const draggableElements = [...container.querySelectorAll('.pokemon-icon:not(.dragging-icon)')];

    return draggableElements.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = x - box.left - box.width / 2;
      if (offset < 0 && offset > closest.offset) {
        return { offset: offset, element: child };
      } else {
        return closest;
      }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // run initially and after new tiers are added
  setupIconReordering();

  // reapply when new Pokémon are dropped or tiers added
  document.addEventListener('drop', () => setupIconReordering());

  function setupMobileSwap() {
    if (!isTouchDevice()) return; // only on mobile

    let firstSelected = null;

    document.querySelectorAll('.pokemon-icon').forEach(icon => {
      icon.addEventListener('click', e => {
        e.stopPropagation();

        // first selection
        if (!firstSelected) {
          firstSelected = icon;
          icon.classList.add('swap-selected');
          return;
        }

        // second selection -> swap
        if (firstSelected !== icon) {
          const firstParent = firstSelected.parentNode;
          const secondParent = icon.parentNode;

          const firstNext = firstSelected.nextSibling === icon ? icon.nextSibling : firstSelected.nextSibling;

          // Swap logic
          secondParent.insertBefore(firstSelected, icon);
          if (firstNext) {
            firstParent.insertBefore(icon, firstNext);
          } else {
            firstParent.appendChild(icon);
          }

          // cleanup
          firstSelected.classList.remove('swap-selected');
          firstSelected = null;
        }
      });
    });

    // tap anywhere else clears selection
    document.body.addEventListener('click', e => {
      if (firstSelected && !e.target.classList.contains('pokemon-icon')) {
        firstSelected.classList.remove('swap-selected');
        firstSelected = null;
      }
    });
  }

  setupMobileSwap();

</script>


</body>

</html>