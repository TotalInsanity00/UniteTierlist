<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="src/Icon.png">
  <title>Pokémon Unite Tier List</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>


  <style>
    body {
      margin: 0;
      background-color: #111;
      font-family: 'Roboto', sans-serif;
      color: white;
      display: flex;
      flex-direction: row;
      height: 100vh;
      overflow-x: hidden;
    }

    .tier-list {
      flex: 3;
      padding: 20px;
      overflow-y: auto;
    }

    .save-reset {
      position: sticky;
      top: 0;
      background-color: #111;
      z-index: 20;
      display: flex;
      justify-content: flex-start;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 2px solid #222;
    }

    .button-group,
    .tier-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      margin-top: 10px;
    }

    button {
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-weight: bold;
    }

    button:hover {
      background-color: #444;
    }

    .tier {
      display: flex;
      flex-direction: row;
      align-items: flex-start;
      /* prevents label from stretching */
      background: #1c1c1c;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .tier-label {
      width: 110px;
      text-align: center;
      font-weight: bold;
      color: #fff;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 10px;
      border-radius: 10px 0 0 10px;
      flex-shrink: 0;
      user-select: none;
      cursor: pointer;
      z-index: 2;
      height: fit-content;
      /* makes label compact */
    }

    .tier-content {
      flex: 1;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-start;
      gap: 10px;
      background: #1a1a1a;
      padding: 10px 12px;
      min-height: 80px;
      border-radius: 0 10px 10px 0;
      cursor: pointer;
      transition: background 0.2s;
    }

    .color-picker {
      margin-top: 5px;
      display: none;
      width: 80%;
      border: none;
      border-radius: 5px;
    }

    .edit-icon {
      display: none;
      position: absolute;
      left: -35px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 15px;
      cursor: pointer;
      background: #333;
      border-radius: 50%;
      padding: 6px;
      border: 1px solid #555;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .edit-icon:hover {
      background: #555;
    }

    .tier-content.dragover {
      border: 2px dashed #888;
    }

    .pokemon-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      flex: 0 0 auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3px;
      cursor: grab;
      transition: transform 0.2s;
      z-index: 1;
    }

    .pokemon-icon:hover {
      transform: scale(1.1);
    }

    .pokemon-icon img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: contain;
      object-position: center;
      background-color: #272727;
      /* inner background replaces ::after layer */
      pointer-events: none;
    }

    /* Gradient ring BEHIND the clipped circle */
    .pokemon-icon::before {
      content: "";
      position: absolute;
      inset: -2px;
      /* slightly bigger to simulate border */
      border-radius: 50%;
      background: linear-gradient(45deg, #ffb7b7, #ff3729);
      z-index: -1;
    }

    .pokemon-icon::after {
      content: "";
      position: absolute;
      inset: 2px;
      /* inner cutoff */
      background: #272727;
      border-radius: 50%;
      z-index: -1;
    }

    .attackers::before {
      background: linear-gradient(45deg, #ffb7b7, #ff3729);
    }

    .allrounders::before {
      background: linear-gradient(45deg, #c587f8, #671faa);
    }

    .defenders::before {
      background: linear-gradient(45deg, #2d5241, #20e973);
    }

    .supporters::before {
      background: linear-gradient(45deg, #fcf7bd, #face08);
    }

    .speedsters::before {
      background: linear-gradient(45deg, #90c2ff, #103cff);
    }


    .side-panel {
      flex: 1;
      background-color: #1a1a1a;
      border-left: 3px solid #333;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 0px;
      overflow: hidden;
    }

    .character-preview {
      width: 100%;
      height: 100%;
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      margin: 0 0 -250px 0;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      background-color: transparent;
      /* optional, just to clear any background */
    }


    .character-preview img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      /* keeps proportions */
      object-position: center;
      padding: 10px;
      /* optional, adds a consistent margin */
      max-height: 300px;
      /* optional cap if your preview area is tall */
    }

    .character-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 2px;
      justify-items: center;
      flex: 1 1 auto;
      overflow-y: auto;
      width: 100%;
      padding-top: 10px;
      overflow-y: scroll;
      /* keeps scrolling functional */
      scrollbar-width: none;
      /* Firefox */
    }

    .character-grid::-webkit-scrollbar {
      display: none;
      /* Chrome, Safari, Edge */
    }

    @media (max-width: 768px) {
      body {
        flex-direction: column;
        height: auto;
      }

      .tier-list {
        flex: none;
        padding-bottom: 150px;
      }

      .side-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 140px;
        background-color: #1a1a1a;
        border-top: 3px solid #333;
        border-left: none;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        z-index: 50;
        padding: 5px;
      }

      .character-preview {
        display: none;
      }

      .character-grid {
        display: grid;
        grid-auto-flow: column;
        grid-template-columns: none;
        overflow-x: auto;
        overflow-y: hidden;
        white-space: nowrap;
        width: 100%;
        padding: 5px;
        gap: 8px;
        justify-items: start;
        scrollbar-width: none;
      }

      .character-grid::-webkit-scrollbar {
        display: none;
      }

      .pokemon-icon {
        flex: 0 0 auto;
        width: 55px;
        height: 55px;
      }

      .edit-icon {
        display: flex;
      }
    }

    .swap-selected {
      outline: 3px solid #ffd700;
      transform: scale(1.1);
    }

    .tier-hitzone {
      height: 20px;
      /* adjust as needed */
      width: 100px;
      /* match .tier-label width */
      background: transparent;
      cursor: pointer;
    }

    .tier-label,
    .tier-content {
      position: relative;
      z-index: 1;
    }
  </style>
</head>

<body>
  <div class="tier-list" id="tierList">
    <div class="save-reset">
      <button id="save">SAVE</button>
      <button id="reset">RESET</button>
    </div>

    <div class="tier-controls">
      <button id="addTier">+ ADD TIER</button>
      <button id="removeTier">- REMOVE TIER</button>
    </div>

    <div id="tiers-container">
      <div class="tier">
        <div class="tier-label" style="background-color:#ff5722;" contenteditable="true">
          S TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#ff5722">
        </div>

        <div class="tier-content"></div>
      </div>

      <div class="tier">
        <div class="tier-label" style="background-color: #ffca28;" contenteditable="true">
          A TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#ffca28">
        </div>

        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #8bc34a;" contenteditable="true">
          B TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#8bc34a">
        </div>

        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #132781;" contenteditable="true">
          C TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#132781">
        </div>

        <div class="tier-content"></div>
      </div>
      <div class="tier">
        <div class="tier-label" style="background-color: #610f75;" contenteditable="true">
          D TIER
          <span class="edit-icon">✏️</span>
          <input type="color" class="color-picker" value="#610f75">
        </div>

        <div class="tier-content"></div>
      </div>
    </div>
  </div>

  <div class="side-panel">
    <div class="character-preview" id="preview" title="Click to view on Unite-DB"></div>


    <div class="character-grid" id="character-grid"></div>
  </div>

  <script>


    const attackers = ['Latios', 'Alolan-Raichu', 'Armarouge', 'Miraidon', 'Mewtwoy', 'Inteleon', 'Chandelure',
      'Dragapult', 'Mew', 'Glaceon', 'Delphox', 'Espeon', 'Duraludon', 'Decidueye', 'Sylveon', 'Gardevoir', 'Pikachu', 'Greninja', 'Venusaur', 'Alolan-Ninetales', 'Cramorant', 'Cinderace'];
    const allrounders = ['Empoleon', 'Pawmot', 'Suicune', 'Tinkaton', 'Ceruledge', 'Falinks', 'Gyarados', 'Metagross', 'Mimikyu',
      'Blaziken', 'Zacian', 'Urshifuss', 'Urshifurs', 'Scizor', 'Tyranitar', 'Buzzwole', 'Azumarill', 'Aegislash', 'Dragonite',
      'Tsareena', 'Charizard', 'Lucario', 'Machamp', 'Garchomp', 'Mewtwox', 'Charizardx', 'mLucario'];
    const defenders = ['Ho-Oh', 'Umbreon', 'Lapras', 'Goodra', 'Trevenant', 'Greedent', 'Mamoswine', 'Blastoise', 'Snorlax', 'Crustle', 'Slowbro'];
    const supporters = ['Latias', 'Alcremie', 'Psyduck', 'Comfey', 'Sableye', 'Clefable', 'Hoopa', 'Blissey', 'Eldegoss', 'Mr-Mime', 'Wigglytuff'];
    const speedsters = ['Galarian-Rapidash', 'Scyther', 'Darkrai', 'Meowscarada', 'Leafeon', 'Zoroark', 'Dodrio', 'Zeraora', 'Talonflame', 'Absol', 'Gengar'];

    const categories = { attackers, allrounders, defenders, supporters, speedsters };
    const grid = document.getElementById('character-grid');
    const previewContainer = document.getElementById('preview');
    const previewImg = previewContainer.querySelector('img');
    let selectedPokemon = null;

    // --- Drag + Touch placement ---
    function setupDragAndDrop() {
      const tiers = document.querySelectorAll('.tier');
      const grid = document.getElementById('character-grid');

      tiers.forEach(tier => {
        const tierContent = tier.querySelector('.tier-content');
        const label = tier.querySelector('.tier-label');

        // Drag/drop
        tierContent.addEventListener('dragover', e => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging, .dragging-icon');
          if (!dragging) return;
          const after = getDragAfterElementTier(tierContent, e.clientX);
          if (after == null) tierContent.appendChild(dragging);
          else tierContent.insertBefore(dragging, after);
        });

        tierContent.addEventListener('drop', e => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging, .dragging-icon');
          if (!dragging) return;
          const after = getDragAfterElementTier(tierContent, e.clientX);
          if (after == null) tierContent.appendChild(dragging);
          else tierContent.insertBefore(dragging, after);
          updatePreviewImage(dragging.dataset.name);
          setupIconReordering();
        });

        // Click anywhere in tier (except label) to place Pokémon
        tier.addEventListener('click', e => {
          if (e.target.closest('.tier-label') || e.target.closest('.color-picker') || e.target.classList.contains('edit-icon')) return;
          if (!selectedPokemon) return;

          tierContent.appendChild(selectedPokemon);
          updatePreviewImage(selectedPokemon.dataset.name);
          selectedPokemon.classList.remove('selected-touch');
          selectedPokemon = null;
          setupIconReordering();
        });

        // Also allow clicking the label to place Pokémon
        label.addEventListener('click', e => {
          if (e.target.closest('.color-picker') || e.target.classList.contains('edit-icon')) return;
          e.stopPropagation();

          const tierContent = label.closest('.tier').querySelector('.tier-content');
          if (selectedPokemon && tierContent) {
            tierContent.appendChild(selectedPokemon);
            updatePreviewImage(selectedPokemon.dataset.name);
            selectedPokemon.classList.remove('selected-touch');
            selectedPokemon = null;
            setupIconReordering();
          }
        });
      });

      // Character grid drag/drop
      grid.addEventListener('dragover', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging, .dragging-icon');
        if (!dragging) return;
        const after = getDragAfterElementGrid(grid, e.clientX, e.clientY);
        if (after == null) grid.appendChild(dragging);
        else grid.insertBefore(dragging, after);
      });

      grid.addEventListener('drop', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging, .dragging-icon');
        if (!dragging) return;
        const after = getDragAfterElementGrid(grid, e.clientX, e.clientY);
        if (after == null) grid.appendChild(dragging);
        else grid.insertBefore(dragging, after);
      });
    }



    // --- Generate Pokémon icons ---
    Object.entries(categories).forEach(([role, names]) => {
      names.forEach(name => {
        const div = document.createElement('div');
        div.className = `pokemon-icon ${role}`;
        div.draggable = true;
        div.dataset.name = name;
        const lower = name.toLowerCase();
        //const settings = imageSettings[lower]?.icon || { scale: 1, xOffset: 0, yOffset: 0 };

        div.innerHTML = `
      <img 
      src="./pokemon/unite_${lower}.png" 
        alt="${name}" 
      >
    `;


        div.addEventListener('dragstart', () => div.classList.add('dragging'));
        div.addEventListener('dragend', () => div.classList.remove('dragging'));

        div.addEventListener('click', e => {
          if (isTouchDevice()) {
            e.stopPropagation();
            if (selectedPokemon === div) {
              div.classList.remove('selected-touch'); selectedPokemon = null;
            } else {
              if (selectedPokemon) selectedPokemon.classList.remove('selected-touch');
              selectedPokemon = div;
              div.classList.add('selected-touch');
            }
          }
          const lower = name.toLowerCase();
          // 👇 changed this line
          updatePreviewImage(name);
          const settings = imageSettings[lower]?.preview || imageSettings[lower]?.icon || { scale: 1, xOffset: 0, yOffset: 0 };
          previewImg.style.transform = `scale(${settings.scale}) translate(${settings.xOffset}px, ${settings.yOffset}px)`;
          previewImg.alt = name;
        });


        grid.appendChild(div);
      });
    });

    document.body.addEventListener('click', e => {
      if (selectedPokemon && !e.target.classList.contains('pokemon-icon')) {
        selectedPokemon.classList.remove('selected-touch');
        selectedPokemon = null;
      }
    });

    const previewLink = document.getElementById('preview-link');

    function updatePreviewImage(name) {
      if (!name) return;
      const lower = name.toLowerCase();
      const previewContainer = document.querySelector('.character-preview');

      previewContainer.style.background = `url('./preview/preview_${lower}.png') no-repeat top center`;
      previewContainer.style.backgroundSize = 'contain';
    }

    // --- Open Pokémon page on click ---
    previewContainer.addEventListener('click', () => {
      const name = previewContainer.style.background
        .match(/preview_(.*?)\.png/i)?.[1]
        ?.replace(/_/g, '-') || null;

      if (name) {
        window.open(`https://unite-db.com/pokemon/${name.toLowerCase()}`, '_blank');
      }
    });


    setupDragAndDrop();

    function getTierListJSON() {
      const tiers = [];
      const unassigned = [];

      // Collect tiers
      document.querySelectorAll('#tiers-container .tier').forEach(tierDiv => {
        const labelDiv = tierDiv.querySelector('.tier-label');
        const tierName = labelDiv.textContent.trim();
        const tierColor = labelDiv.style.backgroundColor;

        const pokemon = [];
        tierDiv.querySelectorAll('.pokemon-icon').forEach(icon => {
          pokemon.push({
            name: icon.dataset.name,
            role: icon.classList.contains('attackers') ? 'attackers' :
              icon.classList.contains('allrounders') ? 'allrounders' :
                icon.classList.contains('defenders') ? 'defenders' :
                  icon.classList.contains('supporters') ? 'supporters' :
                    icon.classList.contains('speedsters') ? 'speedsters' : null
          });
        });

        tiers.push({
          name: tierName,
          color: tierColor,
          pokemon
        });
      });

      // Collect unassigned Pokémon in the grid
      document.querySelectorAll('#character-grid .pokemon-icon').forEach(icon => {
        unassigned.push({
          name: icon.dataset.name,
          role: icon.classList.contains('attackers') ? 'attackers' :
            icon.classList.contains('allrounders') ? 'allrounders' :
              icon.classList.contains('defenders') ? 'defenders' :
                icon.classList.contains('supporters') ? 'supporters' :
                  icon.classList.contains('speedsters') ? 'speedsters' : null
        });
      });

      return { tiers, unassigned };
    }

    // --- Save Tier List as Image ---
    document.getElementById("save").addEventListener("click", async () => {
      const tierList = document.querySelector("#tiers-container");
      const isMobile = /Mobi|Android/i.test(navigator.userAgent);

      if (isMobile && /iPhone|iPad|iPod/.test(navigator.userAgent)) {
        alert(
          "Saving images might not work properly on iOS Safari. If Pokémon icons are missing, please take a screenshot instead."
        );
      }

      // ✅ Temporarily force desktop layout
      document.body.classList.add("force-desktop");

      await document.fonts.ready;
      await Promise.all(
        Array.from(document.images)
          .filter((img) => !img.complete)
          .map(
            (img) =>
              new Promise((resolve) => (img.onload = img.onerror = resolve))
          )
      );

      document.querySelectorAll("img").forEach((img) => {
        if (!img.crossOrigin) img.crossOrigin = "anonymous";
      });

      try {
        const canvas = await html2canvas(tierList, {
          backgroundColor: null,
          useCORS: true,
          scale: 2,
          logging: false,
        });

        const dataUrl = canvas.toDataURL("image/png");
        const link = document.createElement("a");
        link.download = "unite-tier-list.png";
        link.href = dataUrl;
        document.body.appendChild(link);
        link.click();
        link.remove();
      } catch (err) {
        console.error("Save failed:", err);
        alert("Saving failed — see console for details.");
      } finally {
        // ✅ Remove the desktop override after saving
        document.body.classList.remove("force-desktop");
      }
    });



    // --- Reset Tier List ---
    document.getElementById('reset').addEventListener('click', () => {
      const grid = document.getElementById('character-grid');
      const tiers = document.querySelectorAll('.tier-content');

      // Move all Pokémon back to the grid
      tiers.forEach(tier => {
        const icons = [...tier.querySelectorAll('.pokemon-icon')];
        icons.forEach(icon => grid.appendChild(icon));
      });

      // Optional: sort grid back to original order
      const originalOrder = [
        ...attackers,
        ...allrounders,
        ...defenders,
        ...supporters,
        ...speedsters
      ];

      const gridIcons = [...grid.querySelectorAll('.pokemon-icon')];
      gridIcons.sort((a, b) => {
        const indexA = originalOrder.indexOf(a.dataset.name);
        const indexB = originalOrder.indexOf(b.dataset.name);
        return indexA - indexB;
      });

      gridIcons.forEach(icon => grid.appendChild(icon));
    });

    // --- Add Tier Button (unchanged) ---
    document.getElementById("addTier").addEventListener("click", () => {
      const container = document.getElementById("tiers-container");
      const currentTierCount = container.querySelectorAll(".tier").length;

      if (currentTierCount >= 16) {
        alert("You can only have up to 16 tiers!");
        return;
      }

      const tier = document.createElement("div");
      tier.className = "tier";
      const color = "#" + Math.floor(Math.random() * 16777215).toString(16);
      tier.innerHTML = `
      <div class="tier-label" style="background-color:${color};" contenteditable="true">
        NEW TIER
        <span class="edit-icon">✏️</span>
        <input type="color" class="color-picker" value="${color}">
      </div>
      <div class="tier-content"></div>
    `;

      container.appendChild(tier);

      setupDragAndDrop();
      setupColorPickers();
      setupMobilePencils();
      setupIconReordering();
    });


    // --- Remove Tier (fixed so characters return to grid) ---
    document.getElementById('removeTier').addEventListener('click', () => {
      const container = document.getElementById('tiers-container');
      const last = container.lastElementChild;
      const grid = document.getElementById('character-grid');

      if (last) {
        // Move all Pokémon back to the grid before removing the tier
        const icons = last.querySelectorAll('.pokemon-icon');
        icons.forEach(icon => grid.appendChild(icon));

        // Now remove the tier
        container.removeChild(last);
      }
    });


    // --- Color picker + pencil toggle ---
    function setupColorPickers() {
      document.querySelectorAll('.tier-label').forEach(label => {
        const picker = label.querySelector('.color-picker');
        const pencil = label.querySelector('.edit-icon');

        // remove old listeners to avoid duplicates
        label.replaceWith(label.cloneNode(true));
      });

      document.querySelectorAll('.tier-label').forEach(label => {
        const picker = label.querySelector('.color-picker');
        const pencil = label.querySelector('.edit-icon');

        // --- double-click color picker toggle (desktop) ---
        label.addEventListener('dblclick', e => {
          e.stopPropagation();
          picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
        });

        // --- pencil toggle (mobile & desktop) ---
        if (pencil) {
          pencil.onclick = e => {
            e.stopPropagation();
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
          };
        }

        // --- color live update ---
        picker.addEventListener('input', e => {
          label.style.backgroundColor = e.target.value;
        });

        // --- hide picker when clicking outside ---
        label.addEventListener('click', e => e.stopPropagation());
        document.addEventListener('click', e => {
          if (!label.contains(e.target)) picker.style.display = 'none';
        });
      });
    }


    // --- Mobile: fix pencil placement + behavior ---
    function setupMobilePencils() {
      if (window.innerWidth <= 768) {
        document.querySelectorAll('.tier-label').forEach(label => {
          let pencil = label.querySelector('.edit-icon');
          const picker = label.querySelector('.color-picker');

          if (!pencil) {
            pencil = document.createElement('span');
            pencil.className = 'edit-icon';
            pencil.textContent = '✏️';
            label.insertAdjacentElement('afterbegin', pencil);
          }

          pencil.onclick = e => {
            e.stopPropagation();
            picker.style.display = picker.style.display === 'block' ? 'none' : 'block';
          };
        });
      }
    }

    setupColorPickers();
    setupMobilePencils();

    // --- Helper ---
    function isTouchDevice() {
      return 'ontouchstart' in window || navigator.maxTouchPoints > 0;
    }
    // also run again when a new tier is added
    const originalAddTier = document.getElementById('addTier').onclick;
    document.getElementById('addTier').onclick = () => {
      originalAddTier?.();
    };

    // --- Enable Pokémon reordering within tiers ---
    function setupIconReordering() {
      const tiers = document.querySelectorAll('.tier-content');

      tiers.forEach(tier => {
        tier.querySelectorAll('.pokemon-icon').forEach(icon => {
          icon.draggable = true;

          icon.addEventListener('dragstart', e => {
            e.dataTransfer.effectAllowed = 'move';
            icon.classList.add('dragging-icon');
          });

          icon.addEventListener('dragend', () => {
            icon.classList.remove('dragging-icon');
          });
        });

        tier.addEventListener('dragover', e => {
          e.preventDefault();
          const dragging = document.querySelector('.dragging-icon');
          if (!dragging) return;

          const afterElement = getDragAfterElementTier(tier, e.clientX);

          if (afterElement == null) {
            tier.appendChild(dragging);
          } else {
            tier.insertBefore(dragging, afterElement);
          }
        });
      });
    }

    function getDragAfterElementGrid(container, x, y) {
      const draggableElements = [...container.querySelectorAll('.pokemon-icon:not(.dragging-icon)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offsetX = x - (box.left + box.width / 2);
        const offsetY = y - (box.top + box.height / 2);
        const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);
        if (distance < closest.distance) {
          return { distance, element: child };
        } else {
          return closest;
        }
      }, { distance: Number.POSITIVE_INFINITY }).element;
    }

    function getDragAfterElementTier(container, x) {
      const draggableElements = [...container.querySelectorAll('.pokemon-icon:not(.dragging-icon)')];
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = x - box.left - box.width / 2;
        if (offset < 0 && offset > closest.offset) {
          return { offset: offset, element: child };
        } else {
          return closest;
        }
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }


    // run initially and after new tiers are added
    setupIconReordering();

    // reapply when new Pokémon are dropped or tiers added
    document.addEventListener('drop', () => setupIconReordering());

    function setupMobileSwap() {

      let firstSelected = null;

      document.querySelectorAll('.pokemon-icon').forEach(icon => {
        icon.addEventListener('click', e => {
          e.stopPropagation();

          // first selection
          if (!firstSelected) {
            firstSelected = icon;
            icon.classList.add('swap-selected');
            return;
          }

          // second selection -> swap
          if (firstSelected !== icon) {
            const firstParent = firstSelected.parentNode;
            const secondParent = icon.parentNode;

            const firstNext = firstSelected.nextSibling === icon ? icon.nextSibling : firstSelected.nextSibling;

            // Swap logic
            secondParent.insertBefore(firstSelected, icon);
            if (firstNext) {
              firstParent.insertBefore(icon, firstNext);
            } else {
              firstParent.appendChild(icon);
            }

            // cleanup
            firstSelected.classList.remove('swap-selected');
            firstSelected = null;
          }
        });
      });

      // tap anywhere else clears selection
      document.body.addEventListener('click', e => {
        if (firstSelected && !e.target.classList.contains('pokemon-icon')) {
          firstSelected.classList.remove('swap-selected');
          firstSelected = null;
        }
      });
    }

    setupMobileSwap();

  </script>


</body>

</html>